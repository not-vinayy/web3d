<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebGL vs WebGPU Benchmark Results</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background: #fdfdfd;
            margin: 0;
            padding: 20px;
            color: #333;
        }

        h1 {
            text-align: center;
            color: #2c3e50;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .chart-container {
            width: 48%;
            display: inline-block;
            margin: 1%;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 15px;
            border-radius: 8px;
            background: white;
            box-sizing: border-box;
        }

        canvas {
            max-width: 100%;
            height: auto !important;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .file-upload {
            background: #3498db;
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            border: none;
            font-size: 1rem;
        }

        .file-upload:hover {
            background: #2980b9;
        }

        input[type="file"] {
            display: none;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>Benchmark Results Visualization</h1>
            <label class="file-upload">
                Load results.json
                <input type="file" id="fileInput" accept=".json">
            </label>
        </div>

        <div id="charts">
            <div class="chart-container"><canvas id="chartB"></canvas></div>
            <div class="chart-container"><canvas id="chartC"></canvas></div>
            <div class="chart-container"><canvas id="chartD"></canvas></div>
            <div class="chart-container"><canvas id="chartInit"></canvas></div>
        </div>
    </div>

    <script>
        document.getElementById('fileInput').addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function (e) {
                const data = JSON.parse(e.target.result);
                renderCharts(data);
            };
            reader.readAsText(file);
        });

        // Try to load automatically if served from same domain
        fetch('../results.json')
            .then(res => res.json())
            .then(data => renderCharts(data))
            .catch(e => console.log("Could not auto-load results.json, wait for user upload."));

        let charts = {};

        function destroyCharts() {
            Object.values(charts).forEach(c => c.destroy());
            charts = {};
        }

        function createChart(ctxId, type, title, labels, webglData, webgpuData, yAxisLabel) {
            const ctx = document.getElementById(ctxId).getContext('2d');
            charts[ctxId] = new Chart(ctx, {
                type: type,
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'WebGL 2.0',
                            data: webglData,
                            borderColor: '#e74c3c',
                            backgroundColor: 'rgba(231, 76, 60, 0.2)',
                            borderWidth: 2,
                            tension: 0.1
                        },
                        {
                            label: 'WebGPU',
                            data: webgpuData,
                            borderColor: '#3498db',
                            backgroundColor: 'rgba(52, 152, 219, 0.2)',
                            borderWidth: 2,
                            tension: 0.1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: { display: true, text: title, font: { size: 16 } }
                    },
                    scales: {
                        y: { title: { display: true, text: yAxisLabel }, beginAtZero: true },
                        x: { title: { display: true, text: 'Workload Size / Count' } }
                    }
                }
            });
        }

        function extractData(data, scenario, matric) {
            const filter = data.filter(d => d.scenario === scenario && !d.error);
            const counts = [...new Set(filter.map(d => d.count))].sort((a, b) => a - b);

            const webgl = counts.map(c => filter.find(d => d.api === 'webgl' && d.count === c)?.[matric] || 0);
            const webgpu = counts.map(c => filter.find(d => d.api === 'webgpu' && d.count === c)?.[matric] || 0);

            return { counts, webgl, webgpu };
        }

        function renderCharts(data) {
            destroyCharts();

            // Scenario B (Instancing) - FPS
            const d1 = extractData(data, 'B', 'fps');
            createChart('chartB', 'line', 'Scenario B: Geometry Scaling (FPS)', d1.counts, d1.webgl, d1.webgpu, 'Frames Per Second (FPS)');

            // Scenario C (Particles) - FPS
            const d2 = extractData(data, 'C', 'fps');
            createChart('chartC', 'line', 'Scenario C: Particle System (FPS)', d2.counts, d2.webgl, d2.webgpu, 'Frames Per Second (FPS)');

            // Scenario D (Compute) - FPS
            const d3 = extractData(data, 'D', 'fps');
            createChart('chartD', 'line', 'Scenario D: Matrix Multiplication (FPS)', d3.counts, d3.webgl, d3.webgpu, 'Frames Per Second (FPS)');

            // Initialization Times (Avg across all tests for each API)
            const initWebGL = data.filter(d => d.api === 'webgl' && !d.error).map(d => d.initTime);
            const avgInitWebGL = initWebGL.reduce((a, b) => a + b, 0) / initWebGL.length;

            const initWebGPU = data.filter(d => d.api === 'webgpu' && !d.error).map(d => d.initTime);
            const avgInitWebGPU = initWebGPU.reduce((a, b) => a + b, 0) / initWebGPU.length;

            const ctx = document.getElementById('chartInit').getContext('2d');
            charts['chartInit'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Average Initialization Time'],
                    datasets: [
                        { label: 'WebGL 2.0', data: [avgInitWebGL], backgroundColor: '#e74c3c' },
                        { label: 'WebGPU', data: [avgInitWebGPU], backgroundColor: '#3498db' }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: { title: { display: true, text: 'Init Time (Context & Pipeline Setup)', font: { size: 16 } } },
                    scales: { y: { title: { display: true, text: 'Time (ms)' }, beginAtZero: true } }
                }
            });
        }
    </script>
</body>

</html>